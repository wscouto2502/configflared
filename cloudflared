#!/bin/bash

menu_principal() {
    while true; do
        clear

        echo "O que deseja fazer?

        [00]: Listar todos os IPs da maquina
        [01]: Configurar IP Fixo
        [02]: voltar a configuração inicial do IP
        [03]: Configurar Tunnel CloudFlared

        
        [xx]: Sair do instalador"

        read -p "Digite sua opção: " opcao1

        case $opcao1 in
            0|00)
                todos_ips
                ;;
            1|01)
                serve_local_ip_fixo
                ;;
            2|02)
                serve_local_ip_fixo_retorno
                ;;
            3|03)
                #listar ip
                tunnel_cloudflared
                ;;    
            sair|fechar|exit|close|x|xx|XX|X)
                clear
                echo "Obrigado por utilizar!"
                break
                ;;
            *)
                echo "Opção inválida. Pressione Enter para continuar..."
                read
                ;;
        esac
        echo ""
    done
}

serve_local_ip_fixo() {
    clear
    while true; do
        echo "Dados das Interfaces disponiveis"
        echo "------------------------------------------"
        dados_interface

        read -p "Digite o nome da placa de rede (ex: enp0s3): " interface
        read -p "Digite o endereço IP com a máscara (ex: 192.168.0.10/24): " ip_address
        read -p "Digite o gateway, IP do roteador (ex: 192.168.0.1): " gateway
        echo "Digite o(s) servidor(es) DNS separados por espaço (ex: 1.1.1.1 8.8.8.8):"
        read -a dns_servers

        clear
        echo -e "\e[33mNome da placa de rede:\e[97m $interface\e[0m"
        echo -e "\e[33mIP da máquina:\e[97m $ip_address\e[0m"
        echo -e "\e[33mGateway:\e[97m $gateway\e[0m"
        echo -e "\e[33mDNS:\e[97m ${dns_servers[*]}\e[0m"
        echo ""

        read -p "As respostas estão corretas? (Y/N): " confirmacao
        if [[ "$confirmacao" =~ ^[Yy]$ ]]; then
            break
        else
            clear
        fi
    done

    echo "Gerando arquivo de configuração..."
    config=$(cat <<EOF
network:
  version: 2
  ethernets:
    $interface:
      dhcp4: no
      addresses:
        - $ip_address
      routes:
        - to: default
          via: $gateway
      nameservers:
        addresses:
$(for dns in "${dns_servers[@]}"; do echo "          - $dns"; done)
EOF
)

    echo "$config" | sudo tee /etc/netplan/01-installer-config.yaml > /dev/null

    chmod -R 755 /etc/netplan

    clear
    echo ""
    echo ""
    echo ""
    echo ""
    echo -e "\nAplicando configurações..."
    echo ""
    echo -e "\nLista de ip(s) da maquina antes da atualização:"
    echo ""
    ip -o -4 addr show | awk '!/ lo / && !/docker/ && !/veth/ {split($4, a, "/"); print a[1]}'
    echo ""
    echo "seu ip que selecionou: $ip_address"
    echo -p "Aguarde aplicando paremetros..."
    sudo netplan apply > /dev/null 2>&1
    read -p "Concluido! Pressione Enter para voltar ao menu..."
}

tunnel_cloudflared() {
    echo "Função de Tunnel CloudFlared ainda não implementada."
    read -p "Pressione Enter para voltar ao menu..."
}

serve_local_ip_fixo_retorno() {
    sudo rm -rf /etc/netplan/01-installer-config.yaml
    echo "Dados das Interfaces disponiveis antes da restauração"
    echo "------------------------------------------"
    dados_interface
    echo -e "\nCaso esteja utilizando acesso remoto reconecte com o servidor com o novo IP!"
    
    chmod -R 755 /etc/netplan
    echo -p "Aguarde aplicando paremetros..."
    sudo netplan apply > /dev/null 2>&1
    echo ""
    read -p "Concluido! Pressione Enter para voltar ao menu..."
}

todos_ips(){
    clear
    echo "Dados das Interfaces disponiveis"
    dados_interface
    echo ""  # quebra de linha
    read -p "Concluido! Pressione Enter para voltar ao menu..."
}


dados_interface(){

# Lista todas as interfaces ativas (excluindo virtuais e loopback)
interfaces=$(ip -o link show | awk -F': ' '/^[0-9]+: / && $2 !~ /(lo|veth|docker|br-|virbr|vmnet|tun|wg)/ {print $2}')

for iface in $interfaces; do
    # Verifica se a interface tem IP com máscara CIDR
    ip_cidr=$(ip -4 addr show dev "$iface" | grep -oP '(?<=inet\s)\d+(\.\d+){3}/\d+')

    if [ -n "$ip_cidr" ]; then
        # Tenta obter o gateway para essa interface
        gateway=$(ip route show dev "$iface" | awk '/default/ {print $3}')

        # Obtém os servidores DNS (se systemd-resolved estiver ativo)
        dns=$(resolvectl dns "$iface" 2>/dev/null | awk '{$1=""; print $0}' | sed 's/^ *//')

        echo "Interface: $iface"
        echo "  IP:       $ip_cidr"
        echo "  Gateway:  ${gateway:-N/A}"
        echo "  DNS:      ${dns:-N/A}"
        echo ""
    fi
done
}


# Iniciar o script
menu_principal
